# This JSON patch adds the  necessary annotation, port definitions and
# arguments to the PMEM-CSI controller pod.

# PMEM-CSI:
- op: add
  path: /spec/template/metadata/annotations
  value:
    pmem-csi.intel.com/scrape: containers
- op: add
  path: /spec/template/spec/containers/0/ports
  value:
  - name: metrics
    containerPort: 10010
- op: add
  path: /spec/template/spec/containers/0/command/-
  value: -metricsListen=:10010
- op: add
  path: /spec/template/spec/containers/0/livenessProbe
  value:
    # If the PMEM-CSI driver is able to serve metrics,
    # then it is alive.
    httpGet:
      scheme: HTTP
      path: /metrics
      port: metrics
    # Allow it to fail 5 times. This is conservative
    # because the probe is new. It might get reduced
    # to 1 later.
    failureThreshold: 5
    periodSeconds: 10
    successThreshold: 1
    timeoutSeconds: 5
